# Testing

The tests in this directory track expected implementation behavior of SHACL, as implemented by `pyshacl`, and of the principal tool and error-taxonomy contributed by this repository, respectively `case_shacl_inheritance_reviewer` and `shir`.

Some of the tests are based on confirming that the text written for the top repository [README](../README.md) still aligns with previously encountered behaviors.

The remainder of the tests review constraint expansions between subclasses, for some of the `sh:PropertyShape` constraint properties, but not all.  The constraints selected so far have been chosen based on usage in [CASE](https://caseontology.org/) and [UCO](https://unifiedcyberontology.org).  They can be found by reviewing the ontology and data in this file for `shir:reviews` annotation properties.  The function `test_coverage` in [`test_all.py`](test_all.py) double-checks the state of known implementations.

The overall design `case_shacl_inheritance_reviewer` takes is to run SPARQL queries that find any `sh:PropertyShape` that "Expands" the set of nodes that would be validated by SHACL in a subclass beyond what its superclass had previously specified.

Hence, the overall test design is to craft sample ontologies, one focused on each characteristic known to be able to cause an expansion.  The files `PASS_*_ontology.ttl` encode sample ontologies that demonstrate subclasses with `sh:PropertyShape`s that remain the same or contract as the class hierarchy deepens.  The files `XFAIL_*_ontology.ttl` implement ontologies that have some `sh:PropertyShape` that either relaxes or drops a constraint.

The `XFAIL_*_ontology.ttl` files embed a partial representation of the error that they are expected to trigger, attached with `shir:shouldTriggerBroadeningError`.  That is to say, ground truth for each test ontology's expected results is encoded as part of the test.  The function `_test_inheritance_xfail_from_inlined_ground_truth` in [`test_all.py`](test_all.py) validates that exactly the recorded set of errors is triggered.

`pyshacl` is not used to validate data based on the `XFAIL` ontologies, because the examples written for the top-level README currently show sufficiently that there is a mismatch of expectations on shape conformance of classes and subclasses.

To see what the inheritance-validation reports look like for a detected expansion, see `XFAIL_*_inheritance.ttl`.  They are generated by running `make check` in this directory, and used by `pytest`. For review purposes, they are also recorded as Git-tracked artifacts.
